name: Unit Tests

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

# Required permissions for test result publishing
permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  kotlin-tests:
    name: Run Kotlin Tests
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      TEST_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
      TEST_SUPABASE_KEY: ${{ secrets.TEST_SUPABASE_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2 #TODO: Beware of version bump; it breaks the workflow
        with:
          gradle-home-cache-cleanup: true

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: Run Common Unit Tests
        run: ./gradlew testDebugUnitTest -PexcludeTests="**/*IntegrationTest*" --continue

      - name: Upload Kotlin Test Results
        uses: actions/upload-artifact@v4
        if: always() # Upload even if tests fail
        with:
          name: kotlin-test-results
          path: |
            **/build/test-results/**/*.xml
            **/build/reports/tests/**
          retention-days: 30

      - name: Publish Kotlin Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/build/test-results/**/*.xml
          check_name: "Kotlin Test Results"
          comment_title: "Kotlin Test Results"
          fail_on: "test failures"

      - name: Comment PR with Kotlin Test Results
        uses: dorny/test-reporter@v2
        if: always() && github.event_name == 'pull_request'
        with:
          name: 'Kotlin Tests (Common + Android)'
          path: '**/build/test-results/**/*.xml'
          reporter: java-junit
          fail-on-error: false

  # iOS tests
  ios-tests:
    name: Run iOS Tests
    runs-on: macos-latest
    if: false #TODO: Make sure to uncomment once there are iOS tests!
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      TEST_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
      TEST_SUPABASE_KEY: ${{ secrets.TEST_SUPABASE_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2 #TODO: Beware of version bump; it breaks the workflow

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: Run iOS Unit Tests
        run: ./gradlew iosSimulatorArm64Test --continue

      - name: Upload iOS Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-test-results
          path: |
            **/build/test-results/iosSimulatorArm64Test/**/*.xml
            **/build/reports/tests/iosSimulatorArm64Test/**
          retention-days: 30

      - name: Comment PR with iOS Test Results
        uses: dorny/test-reporter@v2
        if: always() && github.event_name == 'pull_request'
        with:
          name: 'iOS Tests'
          path: '**/build/test-results/iosSimulatorArm64Test/**/*.xml'
          reporter: java-junit
          fail-on-error: false

  # Test summary job
  test-summary:
    name: Unified Test Summary
    runs-on: ubuntu-latest
    needs: [kotlin-tests, ios-tests]
    if: always()

    steps:
      - name: Download Kotlin Test Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: kotlin-test-results
          path: kotlin-test-results

      - name: Download iOS Test Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ios-test-results
          path: ios-test-results

      - name: Generate Unified Test Summary
        run: |
          echo "## ðŸ§ª Multi-Platform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count Kotlin tests
          KOTLIN_TEST_FILES=$(find kotlin-test-results -name "*.xml" 2>/dev/null | wc -l || echo "0")
          echo "### Kotlin Tests (Common + Android)" >> $GITHUB_STEP_SUMMARY
          if [ "$KOTLIN_TEST_FILES" -gt 0 ]; then
            echo "âœ… **Status:** Tests executed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ **Test files:** $KOTLIN_TEST_FILES" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** No test results found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count iOS tests
          IOS_TEST_FILES=$(find ios-test-results -name "*.xml" 2>/dev/null | wc -l || echo "0")
          echo "### iOS Tests" >> $GITHUB_STEP_SUMMARY
          if [ "$IOS_TEST_FILES" -gt 0 ]; then
            echo "âœ… **Status:** Tests executed" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ **Test files:** $IOS_TEST_FILES" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** No test results found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Total
          TOTAL_TEST_FILES=$((KOTLIN_TEST_FILES + IOS_TEST_FILES))
          echo "### ðŸ“Š Total" >> $GITHUB_STEP_SUMMARY
          echo "**Combined test files:** $TOTAL_TEST_FILES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ All artifacts retained for 30 days" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” Check individual test result actions for detailed breakdowns" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note:** Full test coverage is available via Codecov on the integration-tests workflow" >> $GITHUB_STEP_SUMMARY